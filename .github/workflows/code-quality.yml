name: Code Quality

on:
    pull_request:
    push:
        branches: [ main ]

env:
    PHP_VERSION: 8.4

jobs:
    code-quality:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ env.PHP_VERSION }}
                    coverage: none
                    tools: composer:v2

            -   name: Get Composer cache dir
                id: composer-cache
                run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

            -   name: Cache Composer downloads
                uses: actions/cache@v4
                with:
                    path: ${{ steps.composer-cache.outputs.dir }}
                    key: composer-${{ runner.os }}-${{ env.PHP_VERSION }}-${{ hashFiles('composer.lock') }}
                    restore-keys: |
                        composer-${{ runner.os }}-php${{ env.PHP_VERSION }}-
                        composer-${{ runner.os }}-
                        composer-

            -   name: Install dependencies
                run: composer install --prefer-dist --no-interaction --no-progress

            -   name: Run PHPStan
                run: vendor/bin/phpstan analyse --configuration=tools/phpstan.neon.dist --error-format=github

            -   name: Run PHP-CS-Fixer
                run: |
                    PHP_CS_FIXER_IGNORE_ENV=1 \
                    vendor/bin/php-cs-fixer fix --diff --dry-run --config=tools/.php-cs-fixer.dist.php